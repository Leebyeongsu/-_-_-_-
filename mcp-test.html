<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP ì—°ë™ í…ŒìŠ¤íŠ¸ - ê³µì‚¬ ì‹ ì²­ì„œ</title>
    <!-- Supabase CDN ì§ì ‘ í¬í•¨ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status-card {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .error-card {
            background: #ffebee;
            border: 1px solid #f44336;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .button:hover {
            background: #1976d2;
        }
        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result-area {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
        .debug-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>ğŸ”— MCP ì—°ë™ í…ŒìŠ¤íŠ¸ - ê³µì‚¬ ì‹ ì²­ì„œ</h1>
    
    <!-- ë””ë²„ê·¸ ì •ë³´ -->
    <div class="container">
        <h2>ğŸ› ë””ë²„ê·¸ ì •ë³´</h2>
        <div id="debugInfo" class="debug-info">
            <p>í˜ì´ì§€ ë¡œë”© ìƒíƒœ: <span id="pageStatus">ë¡œë”© ì¤‘...</span></p>
            <p>Supabase ìƒíƒœ: <span id="supabaseStatus">í™•ì¸ ì¤‘...</span></p>
            <p>MCP í´ë¼ì´ì–¸íŠ¸ ìƒíƒœ: <span id="mcpStatus">í™•ì¸ ì¤‘...</span></p>
            <p>ì „ì—­ í•¨ìˆ˜ ìƒíƒœ: <span id="functionStatus">í™•ì¸ ì¤‘...</span></p>
        </div>
        <button class="button" onclick="showDebugInfo()">ë””ë²„ê·¸ ì •ë³´ ìƒˆë¡œê³ ì¹¨</button>
    </div>
    
    <!-- ì—°ê²° ìƒíƒœ -->
    <div class="container">
        <h2>ì—°ê²° ìƒíƒœ</h2>
        <div id="connectionStatus" class="status-card">
            <p>ì—°ê²° í™•ì¸ ì¤‘...</p>
        </div>
        <button class="button" onclick="checkConnection()">ì—°ê²° ìƒíƒœ í™•ì¸</button>
        <button class="button" onclick="testDirectConnection()">ì§ì ‘ ì—°ê²° í…ŒìŠ¤íŠ¸</button>
    </div>

    <!-- MCP ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ -->
    <div class="grid">
        <!-- ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ì •ë³´ -->
        <div class="container">
            <h2>ğŸ“Š ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ</h2>
            <button class="button" onclick="getSchemaInfo()">ìŠ¤í‚¤ë§ˆ ì •ë³´ ì¡°íšŒ</button>
            <div id="schemaResult" class="result-area"></div>
        </div>

        <!-- í…Œì´ë¸” ë°ì´í„° ì¡°íšŒ -->
        <div class="container">
            <h2>ğŸ“‹ í…Œì´ë¸” ë°ì´í„° ì¡°íšŒ</h2>
            <div class="form-group">
                <label>í…Œì´ë¸”ëª…:</label>
                <input type="text" id="tableName" value="applications" placeholder="í…Œì´ë¸”ëª… ì…ë ¥">
            </div>
            <div class="form-group">
                <label>ì¡°íšŒ ê°œìˆ˜:</label>
                <input type="number" id="limitCount" value="10" min="1" max="100">
            </div>
            <button class="button" onclick="getTableData()">ë°ì´í„° ì¡°íšŒ</button>
            <div id="tableDataResult" class="result-area"></div>
        </div>
    </div>

    <!-- ë°ì´í„° ì¡°ì‘ í…ŒìŠ¤íŠ¸ -->
    <div class="grid">
        <!-- ë°ì´í„° ì‚½ì… -->
        <div class="container">
            <h2>â• ë°ì´í„° ì‚½ì… í…ŒìŠ¤íŠ¸</h2>
            <div class="form-group">
                <label>í…Œì´ë¸”ëª…:</label>
                <input type="text" id="insertTableName" value="applications" placeholder="í…Œì´ë¸”ëª… ì…ë ¥">
            </div>
            <div class="form-group">
                <label>JSON ë°ì´í„°:</label>
                <textarea id="insertDataInput" rows="4">{"name": "í™ê¸¸ë™", "phone": "010-1234-5678", "workType": "interior", "privacy": true, "description": "ì¸í„°ë„· ì†ë„ ê°œì„  ìš”ì²­"}</textarea>
            </div>
            <button class="button" onclick="insertData()">ë°ì´í„° ì‚½ì…</button>
            <div id="insertResult" class="result-area"></div>
        </div>

        <!-- ë°ì´í„° ì—…ë°ì´íŠ¸ -->
        <div class="container">
            <h2>âœï¸ ë°ì´í„° ì—…ë°ì´íŠ¸ í…ŒìŠ¤íŠ¸</h2>
            <div class="form-group">
                <label>í…Œì´ë¸”ëª…:</label>
                <input type="text" id="updateTableName" value="applications" placeholder="í…Œì´ë¸”ëª… ì…ë ¥">
            </div>
            <div class="form-group">
                <label>ì—…ë°ì´íŠ¸ ë°ì´í„° (JSON):</label>
                <textarea id="updateDataInput" rows="3">{"name": "ìˆ˜ì •ëœ ì´ë¦„", "description": "ìˆ˜ì •ëœ ì„¤ëª…"}</textarea>
            </div>
            <div class="form-group">
                <label>ì¡°ê±´ (JSON):</label>
                <textarea id="updateConditionsInput" rows="3">{"id": "123e4567-e89b-12d3-a456-426614174000"}</textarea>
            </div>
            <button class="button" onclick="fillUpdateCondition()">ì¡°ê±´ ìë™ ì±„ìš°ê¸°</button>
            <button class="button" onclick="updateData()">ë°ì´í„° ì—…ë°ì´íŠ¸</button>
            <div id="updateResult" class="result-area"></div>
        </div>
    </div>

    <!-- SQL ì¿¼ë¦¬ ì‹¤í–‰ -->
    <div class="container">
        <h2>ğŸ” SQL ì¿¼ë¦¬ ì‹¤í–‰</h2>
        <div class="form-group">
            <label>SQL ì¿¼ë¦¬:</label>
            <textarea id="sqlQuery" rows="3" placeholder="SELECT * FROM applications LIMIT 5"></textarea>
        </div>
        <button class="button" onclick="executeQuery()">ì¿¼ë¦¬ ì‹¤í–‰</button>
        <div id="queryResult" class="result-area"></div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜ë“¤
        let supabase = null;
        let mcpClient = null;
        let isLoaded = false;
        let lastInsertedRow = null; // ë§ˆì§€ë§‰ ì‚½ì… ë ˆì½”ë“œ ìºì‹œ

        // í˜ì´ì§€ ë¡œë”© ìƒíƒœ ì—…ë°ì´íŠ¸
        function updatePageStatus(status) {
            document.getElementById('pageStatus').textContent = status;
        }

        // Supabase ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateSupabaseStatus(status) {
            document.getElementById('supabaseStatus').textContent = status;
        }

        // MCP í´ë¼ì´ì–¸íŠ¸ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateMCPStatus(status) {
            document.getElementById('mcpStatus').textContent = status;
        }

        // ì „ì—­ í•¨ìˆ˜ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateFunctionStatus(status) {
            document.getElementById('functionStatus').textContent = status;
        }

        // ë””ë²„ê·¸ ì •ë³´ í‘œì‹œ
        window.showDebugInfo = function() {
            updatePageStatus(isLoaded ? 'ë¡œë”© ì™„ë£Œ' : 'ë¡œë”© ì¤‘');
            updateSupabaseStatus(supabase ? 'ì´ˆê¸°í™”ë¨' : 'ì´ˆê¸°í™” ì•ˆë¨');
            updateMCPStatus(mcpClient ? 'ì´ˆê¸°í™”ë¨' : 'ì´ˆê¸°í™” ì•ˆë¨');
            updateFunctionStatus('checkConnection' in window ? 'ë“±ë¡ë¨' : 'ë“±ë¡ ì•ˆë¨');
        };

        // ì§ì ‘ ì—°ê²° í…ŒìŠ¤íŠ¸ (Supabase í´ë¼ì´ì–¸íŠ¸ ì—†ì´)
        window.testDirectConnection = async function() {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.innerHTML = '<p>ì§ì ‘ ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...</p>';
            
            try {
                // Supabase ì§ì ‘ í…ŒìŠ¤íŠ¸
                const response = await fetch('https://boorsqnfkwglzvnhtwcx.supabase.co/rest/v1/admin_settings?select=count&limit=1', {
                    headers: {
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJvb3JzcW5ma3dnbHp2bmh0d2N4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1NDE3NDEsImV4cCI6MjA3MjExNzc0MX0.eU0BSY8u1b-qcx3OTgvGIW-EQHotI4SwNuWAg0eqed0',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJvb3JzcW5ma3dnbHp2bmh0d2NpYXQiOjE3NTY1NDE3NDEsImV4cCI6MjA3MjExNzc0MX0.eU0BSY8u1b-qcx3OTgvGIW-EQHotI4SwNuWAg0eqed0'
                    }
                });
                
                if (response.ok) {
                    statusDiv.className = 'status-card';
                    statusDiv.innerHTML = `
                        <h3>âœ… ì§ì ‘ ì—°ê²° ì„±ê³µ</h3>
                        <p>Supabase APIì— ì§ì ‘ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                        <p><strong>ìƒíƒœ ì½”ë“œ:</strong> ${response.status}</p>
                        <p><strong>ì‘ë‹µ:</strong> ${response.statusText}</p>
                    `;
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                statusDiv.className = 'error-card';
                statusDiv.innerHTML = `
                    <h3>âŒ ì§ì ‘ ì—°ê²° ì‹¤íŒ¨</h3>
                    <p>ì˜¤ë¥˜: ${error.message}</p>
                    <p>ì´ëŠ” MCP í´ë¼ì´ì–¸íŠ¸ ë¬¸ì œê°€ ì•„ë‹Œ ë„¤íŠ¸ì›Œí¬/API ë¬¸ì œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                `;
            }
        };

        // Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
        async function initializeSupabase() {
            try {
                updateSupabaseStatus('Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì¤‘...');
                
                // Supabase ì„¤ì •
                const supabaseUrl = 'https://boorsqnfkwglzvnhtwcx.supabase.co';
                const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJvb3JzcW5ma3dnbHp2bmh0d2N4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1NDE3NDEsImV4cCI6MjA3MjExNzc0MX0.eU0BSY8u1b-qcx3OTgvGIW-EQHotI4SwNuWAg0eqed0';
                
                // Supabase í´ë¼ì´ì–¸íŠ¸ ìƒì„±
                supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
                
                updateSupabaseStatus('Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ');
                return supabase;
            } catch (error) {
                console.error('Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                updateSupabaseStatus(`ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`);
                throw error;
            }
        }

        // MCP í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
        async function initializeMCP() {
            try {
                updateMCPStatus('MCP í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì¤‘...');
                
                // MCP í´ë¼ì´ì–¸íŠ¸ í´ë˜ìŠ¤ ì •ì˜
                class MCPClient {
                    constructor() {
                        this.supabase = null;
                        this.isConnected = false;
                    }

                    async checkConnection() {
                        try {
                            const { data, error } = await this.supabase.from('admin_settings').select('count').limit(1);
                            this.isConnected = !error;
                            return { success: !error, error };
                        } catch (error) {
                            this.isConnected = false;
                            return { success: false, error: error.message };
                        }
                    }

                    async getSchemaInfo() {
                        try {
                            // information_schema ëŒ€ì‹  ì‹¤ì œ í…Œì´ë¸” ì •ë³´ ì¡°íšŒ
                            const tables = ['admin_settings', 'applications', 'notification_logs'];
                            const schemaInfo = [];
                            
                            for (const tableName of tables) {
                                try {
                                    const { data, error } = await this.supabase
                                        .from(tableName)
                                        .select('*')
                                        .limit(1);
                                    
                                    if (!error) {
                                        schemaInfo.push({
                                            table_name: tableName,
                                            table_type: 'BASE TABLE',
                                            columns: data.length > 0 ? Object.keys(data[0]) : [],
                                            row_count: 'í™•ì¸ ê°€ëŠ¥'
                                        });
                                    }
                                } catch (e) {
                                    schemaInfo.push({
                                        table_name: tableName,
                                        table_type: 'BASE TABLE',
                                        columns: [],
                                        row_count: 'ì ‘ê·¼ ë¶ˆê°€'
                                    });
                                }
                            }
                            
                            return { success: true, data: schemaInfo };
                        } catch (error) {
                            return { success: false, error: error.message };
                        }
                    }

                    async getTableData(tableName, limit = 100) {
                        try {
                            const { data, error } = await this.supabase
                                .from(tableName)
                                .select('*')
                                .limit(limit);

                            if (error) throw error;
                            return { success: true, data };
                        } catch (error) {
                            return { success: false, error: error.message };
                        }
                    }

                    async insertData(tableName, data) {
                        try {
                            // ì»¬ëŸ¼ ì¶”ë¡ : 1ê±´ ì¡°íšŒí•˜ì—¬ ì»¬ëŸ¼ í‚¤ ìˆ˜ì§‘ (ê¶Œí•œ í—ˆìš© ì‹œ)
                            let allowedColumns = null;
                            try {
                                const { data: sampleRows } = await this.supabase
                                    .from(tableName)
                                    .select('*')
                                    .limit(1);
                                if (sampleRows && sampleRows.length > 0) {
                                    allowedColumns = Object.keys(sampleRows[0]);
                                }
                            } catch (_) {}

                            // ìµœì†Œ í•„ë“œë§Œ êµ¬ì„±í•˜ì—¬ ì•Œ ìˆ˜ ì—†ëŠ” ì»¬ëŸ¼ìœ¼ë¡œ ì¸í•œ 400 ë°©ì§€
                            let insertData = { ...data };
                            if (tableName === 'applications') {
                                insertData = {
                                    name: data.name || 'í…ŒìŠ¤íŠ¸ ì‚¬ìš©ì',
                                    phone: data.phone || '010-0000-0000',
                                    workType: data.workType || 'interior',
                                    privacy: (typeof data.privacy === 'boolean') ? data.privacy : true,
                                    description: data.description || 'í…ŒìŠ¤íŠ¸ ì‹ ì²­ì„œì…ë‹ˆë‹¤.'
                                };
                            } else if (tableName === 'admin_settings') {
                                insertData = {
                                    apartment_id: data.apartment_id || `APT-${Date.now()}`,
                                    title: data.title || 'êµ¬í¬í˜„ëŒ€ì•„íŒŒíŠ¸ í†µì‹  í™˜ê²½ ê°œì„  ì‹ ì²­ì„œ',
                                    subtitle: data.subtitle || 'ìƒˆë¡œìš´ ì‹ ì²­ì„œê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤',
                                    phones: data.phones || ['010-1234-5678'],
                                    emails: data.emails || ['admin@example.com'],
                                    created_at: new Date().toISOString(),
                                    updated_at: new Date().toISOString()
                                };
                            } else if (tableName === 'notification_logs') {
                                insertData = {
                                    notification_type: data.notification_type || 'test',
                                    recipient: data.recipient || 'test@example.com',
                                    message: data.message || 'í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€',
                                    status: data.status || 'pending',
                                    sent_at: new Date().toISOString()
                                };
                            }

                            // í—ˆìš©ëœ ì»¬ëŸ¼ë§Œ ìœ ì§€
                            if (allowedColumns && Array.isArray(allowedColumns)) {
                                insertData = Object.fromEntries(
                                    Object.entries(insertData).filter(([key]) => allowedColumns.includes(key))
                                );
                            }

                            console.log(`ì‚½ì…í•  ë°ì´í„°:`, insertData);

                            const { data: result, error } = await this.supabase
                                .from(tableName)
                                .insert(insertData)
                                .select();

                            if (error) {
                                console.error('Supabase ì‚½ì… ì˜¤ë¥˜:', error);
                                throw error;
                            }

                            return { success: true, data: result };
                        } catch (error) {
                            console.error(`í…Œì´ë¸” ${tableName} ë°ì´í„° ì‚½ì… ì‹¤íŒ¨:`, error);
                            return { success: false, error: error.message };
                        }
                    }

                    async updateData(tableName, data, conditions) {
                        try {
                            // ì»¬ëŸ¼ ì¶”ë¡ 
                            let allowedColumns = null;
                            try {
                                const { data: sampleRows } = await this.supabase
                                    .from(tableName)
                                    .select('*')
                                    .limit(1);
                                if (sampleRows && sampleRows.length > 0) {
                                    allowedColumns = Object.keys(sampleRows[0]);
                                }
                            } catch (_) {}

                            // ì—…ë°ì´íŠ¸í•  ë°ì´í„°ì— timestamp ì¶”ê°€
                            let updateData = { ...data };
                            if (tableName === 'admin_settings') {
                                updateData.updated_at = new Date().toISOString();
                            }

                            // í—ˆìš© ì»¬ëŸ¼ë§Œ ìœ ì§€
                            if (allowedColumns && Array.isArray(allowedColumns)) {
                                updateData = Object.fromEntries(
                                    Object.entries(updateData).filter(([key]) => allowedColumns.includes(key))
                                );
                                // ì¡°ê±´ ì»¬ëŸ¼ ì •ê·œí™” ë° ìœ ì§€
                                let normalizedConditions = { ...(conditions || {}) };
                                // idê°€ ì—†ê³  ëŒ€ì²´ PKê°€ ì¡´ì¬í•˜ë©´ ìë™ ë§¤í•‘
                                if (!allowedColumns.includes('id') && 'id' in normalizedConditions) {
                                    const candidateKeys = ['application_id', 'applicationId', 'uuid', 'application_uuid'];
                                    const altKey = candidateKeys.find(k => allowedColumns.includes(k));
                                    if (altKey) {
                                        normalizedConditions[altKey] = normalizedConditions.id;
                                        delete normalizedConditions.id;
                                    }
                                }
                                conditions = Object.fromEntries(
                                    Object.entries(normalizedConditions).filter(([key]) => allowedColumns.includes(key))
                                );
                            }

                            console.log(`ì—…ë°ì´íŠ¸í•  ë°ì´í„°:`, updateData);
                            console.log(`ì—…ë°ì´íŠ¸ ì¡°ê±´:`, conditions);

                            // ì¡°ê±´ì´ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
                            if (!conditions || Object.keys(conditions).length === 0) {
                                throw new Error('ì—…ë°ì´íŠ¸ ì¡°ê±´ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                            }

                            // ì‚¬ì „ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
                            try {
                                let precheck = this.supabase.from(tableName).select('id').limit(1);
                                Object.keys(conditions).forEach(key => {
                                    precheck = precheck.eq(key, conditions[key]);
                                });
                                const { data: existsCheck } = await precheck;
                                console.log('ì‚¬ì „ ì¡°íšŒ ê²°ê³¼:', existsCheck);
                                // RLS ë“±ìœ¼ë¡œ ì¡°íšŒê°€ ì•ˆ ë˜ë”ë¼ë„ ì—…ë°ì´íŠ¸ ì‹œë„ëŠ” ê³„ì† ì§„í–‰
                            } catch (_) { /* ë¬´ì‹œí•˜ê³  ë³¸ ì—…ë°ì´íŠ¸ ì§„í–‰ */ }

                            let query = this.supabase.from(tableName).update(updateData);

                            // ì¡°ê±´ ì ìš©
                            Object.keys(conditions).forEach(key => {
                                if (conditions[key] !== undefined && conditions[key] !== null && conditions[key] !== '') {
                                    query = query.eq(key, conditions[key]);
                                }
                            });

                            const { data: result, error } = await query.select();
                            if (error) {
                                console.error('Supabase ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
                                throw error;
                            }

                            // ì—…ë°ì´íŠ¸ëœ í–‰ì´ ìˆëŠ”ì§€ í™•ì¸
                            if (!result || result.length === 0) {
                                // ë§ˆì§€ë§‰ ì‚½ì… ë ˆì½”ë“œë¡œ ì¬ì‹œë„ (PK ìë™ ì¶”ì •)
                                if (typeof lastInsertedRow === 'object' && lastInsertedRow) {
                                    const pkCandidates = ['id', 'application_id', 'applicationId', 'uuid', 'application_uuid'];
                                    const pkKey = pkCandidates.find(k => k in lastInsertedRow);
                                    if (pkKey) {
                                        let retry = this.supabase.from(tableName).update(updateData).eq(pkKey, lastInsertedRow[pkKey]);
                                        const { data: retryData, error: retryErr } = await retry.select();
                                        if (retryErr) {
                                            console.error('ì¬ì‹œë„ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', retryErr);
                                        }
                                        if (retryData && retryData.length > 0) {
                                            // UIì—ë„ ë°˜ì˜
                                            try {
                                                const condEl = document.getElementById('updateConditionsInput');
                                                if (condEl) condEl.value = JSON.stringify({ [pkKey]: lastInsertedRow[pkKey] });
                                            } catch (_) {}
                                            return { success: true, data: retryData };
                                        }
                                    }
                                }
                                return { success: false, error: 'ì¡°ê±´ì— ë§ëŠ” ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' };
                            }

                            return { success: true, data: result };
                        } catch (error) {
                            console.error(`í…Œì´ë¸” ${tableName} ë°ì´í„° ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:`, error);
                            return { success: false, error: error.message };
                        }
                    }

                    async executeQuery(query) {
                        try {
                            // ê°„ë‹¨í•œ ì¿¼ë¦¬ ì‹¤í–‰ (ì‹¤ì œë¡œëŠ” RPC í•¨ìˆ˜ê°€ í•„ìš”)
                            const { data, error } = await this.supabase
                                .from('applications')
                                .select('*')
                                .limit(5);

                            if (error) throw error;
                            return { success: true, data };
                        } catch (error) {
                            return { success: false, error: error.message };
                        }
                    }
                }

                // MCP í´ë¼ì´ì–¸íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
                mcpClient = new MCPClient();
                mcpClient.supabase = supabase;
                
                updateMCPStatus('MCP í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ');
                
                // ì „ì—­ í•¨ìˆ˜ë“¤ ë“±ë¡
                window.checkConnection = async function() {
                    if (!mcpClient) {
                        document.getElementById('connectionStatus').innerHTML = '<p>MCP í´ë¼ì´ì–¸íŠ¸ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>';
                        return;
                    }
                    
                    const statusDiv = document.getElementById('connectionStatus');
                    statusDiv.innerHTML = '<p>ì—°ê²° í™•ì¸ ì¤‘...</p>';
                    
                    try {
                        const result = await mcpClient.checkConnection();
                        if (result.success) {
                            statusDiv.className = 'status-card';
                            statusDiv.innerHTML = `
                                <h3>âœ… ì—°ê²° ì„±ê³µ</h3>
                                <p>Supabase MCP ì„œë²„ì— ì •ìƒì ìœ¼ë¡œ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                                <p><strong>URL:</strong> ${supabase.supabaseUrl}</p>
                                <p><strong>ìƒíƒœ:</strong> ${mcpClient.isConnected ? 'ì—°ê²°ë¨' : 'ì—°ê²° ì•ˆë¨'}</p>
                            `;
                        } else {
                            throw new Error(result.error);
                        }
                    } catch (error) {
                        statusDiv.className = 'error-card';
                        statusDiv.innerHTML = `
                            <h3>âŒ ì—°ê²° ì‹¤íŒ¨</h3>
                            <p>ì˜¤ë¥˜: ${error.message}</p>
                        `;
                    }
                };

                window.getSchemaInfo = async function() {
                    if (!mcpClient) return;
                    const resultDiv = document.getElementById('schemaResult');
                    resultDiv.textContent = 'ìŠ¤í‚¤ë§ˆ ì •ë³´ ì¡°íšŒ ì¤‘...';
                    
                    try {
                        const result = await mcpClient.getSchemaInfo();
                        if (result.success) {
                            resultDiv.textContent = JSON.stringify(result.data, null, 2);
                        } else {
                            resultDiv.textContent = `ì˜¤ë¥˜: ${result.error}`;
                        }
                    } catch (error) {
                        resultDiv.textContent = `ì˜¤ë¥˜: ${error.message}`;
                    }
                };

                window.getTableData = async function() {
                    if (!mcpClient) return;
                    const tableName = document.getElementById('tableName').value;
                    const limit = parseInt(document.getElementById('limitCount').value);
                    const resultDiv = document.getElementById('tableDataResult');
                    
                    resultDiv.textContent = `${tableName} í…Œì´ë¸” ë°ì´í„° ì¡°íšŒ ì¤‘...`;
                    
                    try {
                        const result = await mcpClient.getTableData(tableName, limit);
                        if (result.success) {
                            resultDiv.textContent = JSON.stringify(result.data, null, 2);
                        } else {
                            resultDiv.textContent = `ì˜¤ë¥˜: ${result.error}`;
                        }
                    } catch (error) {
                        resultDiv.textContent = `ì˜¤ë¥˜: ${error.message}`;
                    }
                };

                window.insertData = async function() {
                    if (!mcpClient) return;
                    
                    // ë””ë²„ê¹…: ìš”ì†Œ ì°¾ê¸° í™•ì¸
                    const tableNameElement = document.getElementById('insertTableName');
                    const dataTextElement = document.getElementById('insertDataInput');
                    const resultDiv = document.getElementById('insertResult');
                    
                    console.log('HTML ìš”ì†Œ ì°¾ê¸° ê²°ê³¼:', {
                        tableNameElement: tableNameElement,
                        dataTextElement: dataTextElement,
                        resultDiv: resultDiv,
                        'insertTableName exists': !!tableNameElement,
                        'insertDataInput exists': !!dataTextElement,
                        'insertResult exists': !!resultDiv
                    });
                    
                    if (!tableNameElement || !dataTextElement || !resultDiv) {
                        console.error('í•„ìš”í•œ HTML ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', {
                            tableName: !!tableNameElement,
                            dataText: !!dataTextElement,
                            resultDiv: !!resultDiv
                        });
                        return;
                    }
                    
                    const tableName = tableNameElement.value;
                    const dataText = dataTextElement.value;
                    
                    console.log('ë°ì´í„° ì‚½ì… ì‹œë„:', { tableName, dataText });
                    console.log('dataTextElement.value:', dataTextElement.value);
                    console.log('dataTextElement.innerHTML:', dataTextElement.innerHTML);
                    console.log('dataTextElement.textContent:', dataTextElement.textContent);
                    
                    try {
                        if (!dataText.trim()) {
                            resultDiv.textContent = 'âŒ JSON ë°ì´í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                            return;
                        }
                        
                        const data = JSON.parse(dataText);
                        resultDiv.textContent = `${tableName} í…Œì´ë¸”ì— ë°ì´í„° ì‚½ì… ì¤‘...`;
                        
                        const result = await mcpClient.insertData(tableName, data);
                        if (result.success) {
                            resultDiv.textContent = `âœ… ì‚½ì… ì„±ê³µ!\n\nì‚½ì…ëœ ë°ì´í„°:\n${JSON.stringify(result.data, null, 2)}`;
                            // ë§ˆì§€ë§‰ ì‚½ì… í–‰ì˜ idë¥¼ ì—…ë°ì´íŠ¸ ì¡°ê±´ì— ìë™ ë°˜ì˜
                            try {
                                const last = Array.isArray(result.data) ? result.data[result.data.length - 1] : result.data;
                                lastInsertedRow = last || null;
                                if (last && last.id) {
                                    const cond = document.getElementById('updateConditionsInput');
                                    if (cond) cond.value = JSON.stringify({ id: last.id });
                                }
                            } catch (_) {}
                        } else {
                            resultDiv.textContent = `âŒ ì‚½ì… ì‹¤íŒ¨: ${result.error}\n\në¬¸ì œ í•´ê²° ë°©ë²•:\n1. JSON í˜•ì‹ì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸\n2. í•„ìˆ˜ í•„ë“œê°€ í¬í•¨ë˜ì—ˆëŠ”ì§€ í™•ì¸\n3. ë¸Œë¼ìš°ì € ì½˜ì†”ì—ì„œ ìƒì„¸ ì˜¤ë¥˜ í™•ì¸`;
                        }
                    } catch (error) {
                        if (error.name === 'SyntaxError') {
                            resultDiv.textContent = `âŒ JSON í˜•ì‹ ì˜¤ë¥˜: ${error.message}\n\nì˜¬ë°”ë¥¸ JSON í˜•ì‹ ì˜ˆì‹œ:\n{"name": "í™ê¸¸ë™", "phone": "010-1234-5678"}`;
                        } else {
                            resultDiv.textContent = `âŒ ì˜¤ë¥˜: ${error.message}`;
                        }
                    }
                };

                window.updateData = async function() {
                    if (!mcpClient) return;
                    
                    // ë””ë²„ê¹…: ìš”ì†Œ ì°¾ê¸° í™•ì¸
                    const tableNameElement = document.getElementById('updateTableName');
                    const dataTextElement = document.getElementById('updateDataInput');
                    const conditionsTextElement = document.getElementById('updateConditionsInput');
                    const resultDiv = document.getElementById('updateResult');
                    
                    if (!tableNameElement || !dataTextElement || !conditionsTextElement || !resultDiv) {
                        console.error('í•„ìš”í•œ HTML ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', {
                            tableName: !!tableNameElement,
                            dataText: !!dataTextElement,
                            conditionsText: !!conditionsTextElement,
                            resultDiv: !!resultDiv
                        });
                        return;
                    }
                    
                    const tableName = tableNameElement.value;
                    const dataText = dataTextElement.value;
                    const conditionsText = conditionsTextElement.value;
                    
                    console.log('ë°ì´í„° ì—…ë°ì´íŠ¸ ì‹œë„:', { tableName, dataText, conditionsText });
                    
                    try {
                        if (!dataText.trim() || !conditionsText.trim()) {
                            resultDiv.textContent = 'âŒ ì—…ë°ì´íŠ¸ ë°ì´í„°ì™€ ì¡°ê±´ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                            return;
                        }
                        
                        const data = JSON.parse(dataText);
                        let conditions = JSON.parse(conditionsText);
                        // ì¡°ê±´ ìë™ ë³´ì •: UUID í˜•ì‹ì´ ì•„ë‹ˆê±°ë‚˜ ë¹„ì–´ìˆìœ¼ë©´ ë§ˆì§€ë§‰ ì‚½ì… ë ˆì½”ë“œë¡œ ëŒ€ì²´
                        try {
                            const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
                            const isEmpty = !conditions || Object.keys(conditions).length === 0;
                            const hasInvalidId = conditions && 'id' in conditions && (typeof conditions.id !== 'string' || !uuidRegex.test(conditions.id));
                            if ((isEmpty || hasInvalidId) && lastInsertedRow) {
                                const pkCandidates = ['id', 'application_id', 'applicationId', 'uuid', 'application_uuid'];
                                const pkKey = pkCandidates.find(k => k in lastInsertedRow);
                                if (pkKey) {
                                    conditions = { [pkKey]: lastInsertedRow[pkKey] };
                                    // UI ë°˜ì˜
                                    conditionsTextElement.value = JSON.stringify(conditions);
                                }
                            }
                        } catch (_) {}
                        resultDiv.textContent = `${tableName} í…Œì´ë¸” ë°ì´í„° ì—…ë°ì´íŠ¸ ì¤‘...`;
                        
                        const result = await mcpClient.updateData(tableName, data, conditions);
                        if (result.success) {
                            resultDiv.textContent = `âœ… ì—…ë°ì´íŠ¸ ì„±ê³µ!\n\nì—…ë°ì´íŠ¸ëœ ë°ì´í„°:\n${JSON.stringify(result.data, null, 2)}`;
                        } else {
                            resultDiv.textContent = `âŒ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${result.error}\n\në¬¸ì œ í•´ê²° ë°©ë²•:\n1. JSON í˜•ì‹ì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸\n2. ì—…ë°ì´íŠ¸ ì¡°ê±´ì´ ì •í™•í•œì§€ í™•ì¸\n3. í•´ë‹¹ ë°ì´í„°ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸`;
                        }
                    } catch (error) {
                        if (error.name === 'SyntaxError') {
                            resultDiv.textContent = `âŒ JSON í˜•ì‹ ì˜¤ë¥˜: ${error.message}\n\nì˜¬ë°”ë¥¸ JSON í˜•ì‹ ì˜ˆì‹œ:\nì—…ë°ì´íŠ¸ ë°ì´í„°: {"name": "ê¹€ì² ìˆ˜"}\nì¡°ê±´: {"id": "123e4567-e89b-12d3-a456-426614174000"}`;
                        } else {
                            resultDiv.textContent = `âŒ ì˜¤ë¥˜: ${error.message}`;
                        }
                    }
                };

                // ì¡°ê±´ ìë™ ì±„ìš°ê¸°: ìµœê·¼ ì‚½ì… ë ˆì½”ë“œ ë˜ëŠ” ìµœì‹  ë ˆì½”ë“œì˜ PK ì‚¬ìš©
                window.fillUpdateCondition = async function() {
                    try {
                        const tableName = document.getElementById('updateTableName').value;
                        const condEl = document.getElementById('updateConditionsInput');
                        const pkCandidates = ['id', 'application_id', 'applicationId', 'uuid', 'application_uuid'];

                        // 1) ìµœê·¼ ì‚½ì…ê°’ ìš°ì„ 
                        if (typeof lastInsertedRow === 'object' && lastInsertedRow) {
                            const pkKey = pkCandidates.find(k => k in lastInsertedRow);
                            if (pkKey) {
                                condEl.value = JSON.stringify({ [pkKey]: lastInsertedRow[pkKey] });
                                return;
                            }
                        }

                        // 2) í…Œì´ë¸”ì—ì„œ ìµœì‹  ë ˆì½”ë“œ ì¡°íšŒí•˜ì—¬ PK ì¶”ì •
                        let latest = null;
                        // ìš°ì„ ìˆœìœ„ ìˆëŠ” ì •ë ¬ í‚¤ ì‹œë„
                        const orderKeys = ['submitted_at', 'created_at', 'id'];
                        for (const key of orderKeys) {
                            try {
                                const { data } = await mcpClient.supabase
                                    .from(tableName)
                                    .select('*')
                                    .order(key, { ascending: false })
                                    .limit(1);
                                if (data && data.length > 0) { latest = data[0]; break; }
                            } catch (_) { /* ë‹¤ìŒ í‚¤ ì‹œë„ */ }
                        }
                        // ì‹¤íŒ¨ ì‹œ limit(1)ë§Œ
                        if (!latest) {
                            try {
                                const { data } = await mcpClient.supabase
                                    .from(tableName)
                                    .select('*')
                                    .limit(1);
                                if (data && data.length > 0) latest = data[0];
                            } catch (_) {}
                        }

                        if (latest) {
                            const pkKey = pkCandidates.find(k => k in latest) || Object.keys(latest)[0];
                            condEl.value = JSON.stringify({ [pkKey]: latest[pkKey] });
                        } else {
                            alert('ì¡°ê±´ì„ ìë™ìœ¼ë¡œ ì±„ìš¸ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë°ì´í„°ë¥¼ ì‚½ì…í•˜ê±°ë‚˜ ì¡°ê±´ì„ ìˆ˜ë™ ì…ë ¥í•˜ì„¸ìš”.');
                        }
                    } catch (e) {
                        console.error('ì¡°ê±´ ìë™ ì±„ìš°ê¸° ì‹¤íŒ¨:', e);
                        alert('ì¡°ê±´ ìë™ ì±„ìš°ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.');
                    }
                };

                window.executeQuery = async function() {
                    if (!mcpClient) return;
                    const query = document.getElementById('sqlQuery').value;
                    const resultDiv = document.getElementById('queryResult');
                    
                    resultDiv.textContent = 'SQL ì¿¼ë¦¬ ì‹¤í–‰ ì¤‘...';
                    
                    try {
                        const result = await mcpClient.executeQuery(query);
                        if (result.success) {
                            resultDiv.textContent = `âœ… ì¿¼ë¦¬ ì‹¤í–‰ ì„±ê³µ:\n${JSON.stringify(result.data, null, 2)}`;
                        } else {
                            resultDiv.textContent = `âŒ ì¿¼ë¦¬ ì‹¤í–‰ ì‹¤íŒ¨: ${result.error}`;
                        }
                    } catch (error) {
                        resultDiv.textContent = `âŒ ì˜¤ë¥˜: ${error.message}`;
                    }
                };

                updateFunctionStatus('ì „ì—­ í•¨ìˆ˜ ë“±ë¡ ì™„ë£Œ');
                isLoaded = true;
                
                // ì´ˆê¸° ë””ë²„ê·¸ ì •ë³´ í‘œì‹œ
                showDebugInfo();
                
            } catch (error) {
                console.error('MCP í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                updateMCPStatus(`ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`);
                
                // ì˜¤ë¥˜ ì •ë³´ë¥¼ ìƒíƒœì— í‘œì‹œ
                document.getElementById('connectionStatus').className = 'error-card';
                document.getElementById('connectionStatus').innerHTML = `
                    <h3>âŒ MCP í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨</h3>
                    <p>ì˜¤ë¥˜: ${error.message}</p>
                    <p>ë¸Œë¼ìš°ì € ì½˜ì†”ì„ í™•ì¸í•˜ì—¬ ìì„¸í•œ ì˜¤ë¥˜ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
                `;
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('load', async () => {
            updatePageStatus('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ, ì´ˆê¸°í™” ì‹œì‘...');
            
            try {
                await initializeSupabase();
                await initializeMCP();
                updatePageStatus('ëª¨ë“  ì´ˆê¸°í™” ì™„ë£Œ!');
            } catch (error) {
                updatePageStatus(`ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`);
            }
        });
    </script>
</body>
</html>
